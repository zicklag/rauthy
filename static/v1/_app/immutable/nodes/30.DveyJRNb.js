import"../chunks/disclose-version.BDr9Qe-U.js";import{p as as,a3 as y,o as ts,a4 as O,a as os,j as s,a6 as m,$ as Ne,g as e,a5 as o,a7 as C,a9 as R,a8 as b,h as is}from"../chunks/index-client.wsxBsMrC.js";import{s as u}from"../chunks/render.CGk_31K2.js";import{i as $}from"../chunks/if.CdP3FEr9.js";import{a as t,t as A,c as Z,b as L}from"../chunks/template.CyQ6qVeq.js";import{h as ds}from"../chunks/svelte-head.2q0gYbHo.js";import{B as z,s as Fe,t as Je,a as Te}from"../chunks/Button.BsAE8GCO.js";import{s as ns}from"../chunks/helpers.DikdX20z.js";import{p as d}from"../chunks/proxy.MUfQDWlv.js";import{r as ge}from"../chunks/legacy-client.Dm1n63jC.js";import{c as Ge,a as De,I as ps}from"../chunks/Input.CbYO_vsg.js";import{z as ls,u as cs,A as us,n as He,B as ws,D as vs,E as ms,F as Ee,G as qe,H as fs}from"../chunks/dataFetching.BTF7Y2Cd.js";import{P as Me}from"../chunks/PasswordPolicy.DFXAbMJT.js";import{P as he}from"../chunks/PasswordInput.CYtyiDqV.js";import{W as Be}from"../chunks/WebauthnRequest.CJdyVez7.js";import{L as gs}from"../chunks/LangSelector.Q_ihhFqZ.js";import"../chunks/is_dev.svelte.smBQ6gDx.js";import{u as hs}from"../chunks/i18n.svelte.B_PCuqyN.js";import{M as ys,C as $s}from"../chunks/ContentCenter.24rd6EYh.js";import{T as _s}from"../chunks/Template.D8ipGA-s.js";import"../chunks/param.svelte.cJM6dcHK.js";var ks=A('<div class="success svelte-14344wy"> <br> </div>'),Cs=A("<div><!> <!> <!> <!> <!> <!></div>"),Rs=A('<div class="success svelte-14344wy"><p> </p> <p> </p> <!></div>'),bs=A("<div><!> <!> <!></div>"),Ls=A('<!> <h1> </h1> <p> </p> <p> <a target="_blank" class="svelte-14344wy">FIDO Alliance</a></p> <div><!> <!></div> <!>',1),Ns=A('<div class="success svelte-14344wy"> <br> <br> <a class="svelte-14344wy">Link</a></div>'),Ds=A("<!> <h1>Password Reset</h1> <!> <!> <!> <!> <!> <!>",1),Es=A('<div class="err svelte-14344wy"> </div>'),qs=A('<div class="container"><!> <!></div>'),xs=A("<!> <!> <!>",1);function Ks(Xe,Ye){as(Ye,!0);const U="150px",Q="320px";let r=hs(),l=y(void 0),N=y(!1),D=y(""),ee=y(""),se=y(""),re=y(""),g=y(!1),ae=y(!1),te=y(!1),P=y(void 0),i=y(d({passkeyName:"",password:"",passwordConfirm:""})),K=y(d({})),xe=y(void 0),Ke=y(void 0);ts(async()=>{s(ee,"password_reset")});function Ae(){window.location.replace("/auth/v1/account")}function Pe(){if(e(l)){const w=e(l).password_policy.length_min>24?e(l).password_policy.length_min:24;let _=us(w,e(l).password_policy.include_lower_case,e(l).password_policy.include_upper_case,e(l).password_policy.include_digits,e(l).password_policy.include_special);e(i).password=_,e(i).passwordConfirm=_}}async function Ie(){if(!e(l)){console.error("template data is undefined");return}s(D,"");try{await e(xe).validate(e(i),{abortEarly:!1}),s(K,d({}))}catch(n){s(K,d(He(n)));return}const w=e(i).passkeyName;if(w.length<2){s(D,d(r.mfa.passkeyNameErr));return}let _={passkey_name:w,magic_link_id:e(l).magic_link_id},f=await ms(e(l).user_id,_,e(l).csrf_token);if(f.status===200){let n=await f.json();n.publicKey.authenticatorSelection.userVerification="required",n.publicKey.challenge=Ee(n.publicKey.challenge),n.publicKey.user.id=Ee(n.publicKey.user.id),n.publicKey.excludeCredentials=n.publicKey.excludeCredentials,n.publicKey.excludeCredentials&&(n.publicKey.excludeCredentials=n.publicKey.excludeCredentials.map(V=>(V.id=Ee(V.id),V)));let E=await navigator.credentials.create(n),I={passkey_name:w,data:{id:E.id,rawId:qe(E.rawId),response:{attestationObject:qe(E.response.attestationObject),clientDataJSON:qe(E.response.clientDataJSON)},type:E.type},magic_link_id:e(l).magic_link_id};f=await fs(userId,I,e(l).csrf_token),f.status===201?(s(i,d({passkeyName:"",password:"",passwordConfirm:""})),s(g,!0)):(le(),console.error(f))}else{le();let n=await f.json();console.error(n.error),console.error(n.message)}}async function je(){var w,_;try{await e(Ke).validate(e(i),{abortEarly:!1}),s(K,d({}))}catch(f){s(K,d(He(f)));return}if(e(ae)){if(e(i).password.length>256){s(D,"max 256");return}if(e(i).password!==e(i).passwordConfirm){s(D,d(r.passwordReset.passwordNoMatch));return}else s(D,"");if((w=e(l))!=null&&w.needs_mfa){let f=await ws((_=e(l))==null?void 0:_.user_id,{purpose:"PasswordReset"}),n=await f.json();if(!f.ok){s(D,d(n.message)),s(N,!1);return}if(n.user_id!==e(l).user_id){s(D,"MFA user ID does not match - this should never happen"),s(N,!1);return}s(P,d(n))}else await Se()}}async function Se(w){var n;if(!e(l))return;s(N,!0);const _={password:e(i).password,magic_link_id:e(l).magic_link_id,mfa_code:w},f=await vs(e(l).user_id,_,(n=e(l))==null?void 0:n.csrf_token);if(f.ok)s(D,""),s(i,d({passkeyName:"",password:"",passwordConfirm:""})),s(re,d(f.headers.get("Location"))),console.log("redirectUri: "+e(re)),s(g,!0);else{const E=await f.json();s(D,d(E.message))}s(N,!1)}function le(){s(P,void 0),s(D,d(r.mfa.errorReg))}function We(w){w&&(s(P,void 0),Se(w.code))}ge(()=>{r&&(s(xe,d(Ge().shape({passkeyName:De().required(r.common.required).matches(cs,r.mfa.passkeyNameErr)}))),s(Ke,d(Ge().shape({password:De().required(r.common.required),passwordConfirm:De().required(r.common.required)}))))}),ge(()=>{e(se)&&s(i,d({passkeyName:"",password:"",passwordConfirm:""}))}),ge(()=>{var w;((w=e(i).password)==null?void 0:w.length)>0&&e(i).password===e(i).passwordConfirm&&s(te,!0)}),ge(()=>{e(g)&&setTimeout(()=>{e(re)?window.location.replace(e(re)):Ae()},5e3)});var Oe=xs();ds(w=>{var _=Z(),f=O(_);{var n=I=>{var V=Z(),oe=O(V);{var ie=F=>{m(()=>Ne.title=r.passwordReset.newAccount)},ce=F=>{var ue=Z(),ye=O(ue);{var $e=k=>{m(()=>Ne.title=r.passwordReset.passwordReset)};$(ye,k=>{e(ee)==="password_reset"&&k($e)},!0)}t(F,ue)};$(oe,F=>{e(ee).startsWith("new_user")?F(ie):F(ce,!1)})}t(I,V)},E=I=>{Ne.title="Password"};$(f,I=>{r?I(n):I(E,!1)})}t(w,_)});var Ue=O(Oe);_s(Ue,{id:ls,get value(){return e(l)},set value(w){s(l,d(w))}});var Ve=o(Ue,2);ys(Ve,{children:(w,_)=>{$s(w,{children:(f,n)=>{var E=Z(),I=O(E);{var V=oe=>{var ie=qs(),ce=C(ie);{var F=k=>{var j=Ls(),M=O(j);{var _e=a=>{Be(a,{onSuccess:We,onError:le,get data(){return e(P)},set data(h){s(P,d(h))}})};$(M,a=>{e(P)&&a(_e)})}var J=o(M,2),we=C(J,!0);R(J);var B=o(J,2),ke=C(B,!0);R(B);var X=o(B,2),de=C(X,!0),ve=o(de);R(X);var T=o(X,2);ns(T,"margin-bottom","1rem");var ne=C(T);z(ne,{width:U,level:2,get isDisabled(){return e(g)},get isLoading(){return e(N)},set isLoading(a){s(N,d(a))},$$events:{click:()=>s(se,"passkey")},children:(a,h)=>{b();var q=L();m(()=>u(q,r.passwordReset.passwordless)),t(a,q)},$$slots:{default:!0}});var Ce=o(ne,2);z(Ce,{width:U,level:3,get isDisabled(){return e(g)},get isLoading(){return e(N)},set isLoading(a){s(N,d(a))},$$events:{click:()=>s(se,"password")},children:(a,h)=>{b();var q=L();m(()=>u(q,r.passwordReset.password)),t(a,q)},$$slots:{default:!0}}),R(T);var Re=o(T,2);{var c=a=>{var h=Cs(),q=C(h);Me(q,{get policy(){return e(l).password_policy},get password(){return e(i).password},get accepted(){return e(ae)},set accepted(v){s(ae,d(v))}});var me=o(q,2);he(me,{get error(){return e(K).password},autocomplete:"new-password",get placeholder(){return r.passwordReset.password},width:Q,get showCopy(){return e(te)},get disabled(){return e(g)},get value(){return e(i).password},set value(v){e(i).password=v},children:(v,S)=>{b();var p=L();m(()=>u(p,r.passwordReset.password.toUpperCase())),t(v,p)},$$slots:{default:!0}});var Y=o(me,2);he(Y,{get error(){return e(K).passwordConfirm},autocomplete:"new-password",get placeholder(){return r.passwordReset.passwordConfirm},width:Q,get showCopy(){return e(te)},get disabled(){return e(g)},get value(){return e(i).passwordConfirm},set value(v){e(i).passwordConfirm=v},children:(v,S)=>{b();var p=L();m(()=>u(p,r.passwordReset.passwordConfirm.toUpperCase())),t(v,p)},$$slots:{default:!0}});var G=o(Y,2);z(G,{width:U,level:3,get isDisabled(){return e(g)},$$events:{click:Pe},children:(v,S)=>{b();var p=L();m(()=>u(p,r.passwordReset.generate)),t(v,p)},$$slots:{default:!0}});var pe=o(G,2);z(pe,{width:U,level:2,get isDisabled(){return e(g)},get isLoading(){return e(N)},set isLoading(v){s(N,d(v))},$$events:{click:je},children:(v,S)=>{b();var p=L();m(()=>u(p,r.common.save)),t(v,p)},$$slots:{default:!0}});var fe=o(pe,2);{var be=v=>{var S=ks(),p=C(S),H=o(p,2);R(S),m(()=>{u(p,`${r.passwordReset.success1??""} `),u(H,` ${r.passwordReset.success2??""}`)}),t(v,S)};$(fe,v=>{e(g)&&v(be)})}R(h),Je(3,h,()=>Te),t(a,h)},x=a=>{var h=Z(),q=O(h);{var me=Y=>{var G=bs(),pe=C(G);ps(pe,{autocomplete:"off",get placeholder(){return r.mfa.passkeyName},width:Q,get disabled(){return e(g)},get value(){return e(i).passkeyName},set value(p){e(i).passkeyName=p},get error(){return e(K).passkeyName},set error(p){e(K).passkeyName=p},$$events:{enter:Ie},children:(p,H)=>{b();var W=L();m(()=>u(W,r.mfa.passkeyName)),t(p,W)},$$slots:{default:!0}});var fe=o(pe,2),be=is(()=>e(g)?2:1);z(fe,{width:U,get level(){return e(be)},get isDisabled(){return e(g)},$$events:{click:Ie},children:(p,H)=>{b();var W=L();m(()=>u(W,r.mfa.register)),t(p,W)},$$slots:{default:!0}});var v=o(fe,2);{var S=p=>{var H=Rs(),W=C(H),Qe=C(W,!0);R(W);var Le=o(W,2),es=C(Le,!0);R(Le);var ss=o(Le,2);z(ss,{width:U,level:1,$$events:{click:Ae},children:(rs,As)=>{b();var ze=L();m(()=>u(ze,r.passwordReset.accountLogin)),t(rs,ze)},$$slots:{default:!0}}),R(H),m(()=>{u(Qe,r.passwordReset.successPasskey1),u(es,r.passwordReset.successPasskey2)}),t(p,H)};$(v,p=>{e(g)&&p(S)})}R(G),Je(3,G,()=>Te),t(Y,G)};$(q,Y=>{e(se)==="passkey"&&Y(me)},!0)}t(a,h)};$(Re,a=>{e(se)==="password"?a(c):a(x,!1)})}m(()=>{u(we,r.passwordReset.newAccount),u(ke,r.passwordReset.newAccDesc1),u(de,r.passwordReset.newAccDesc2),Fe(ve,"href",r.passwordReset.fidoLink)}),t(k,j)},ue=k=>{var j=Z(),M=O(j);{var _e=J=>{var we=Ds(),B=O(we);{var ke=c=>{Be(c,{purpose:"PasswordReset",onSuccess:We,onError:le,get data(){return e(P)},set data(x){s(P,d(x))}})};$(B,c=>{e(P)&&c(ke)})}var X=o(B,4);Me(X,{get policy(){return e(l).password_policy},get password(){return e(i).password},get accepted(){return e(ae)},set accepted(c){s(ae,d(c))}});var de=o(X,2);he(de,{get error(){return e(K).password},autocomplete:"new-password",get placeholder(){return r.passwordReset.password},width:Q,get showCopy(){return e(te)},get value(){return e(i).password},set value(c){e(i).password=c},children:(c,x)=>{b();var a=L();m(()=>u(a,r.passwordReset.password.toUpperCase())),t(c,a)},$$slots:{default:!0}});var ve=o(de,2);he(ve,{get error(){return e(K).passwordConfirm},autocomplete:"new-password",get placeholder(){return r.passwordReset.passwordConfirm},width:Q,get showCopy(){return e(te)},get value(){return e(i).passwordConfirm},set value(c){e(i).passwordConfirm=c},children:(c,x)=>{b();var a=L();m(()=>u(a,r.passwordReset.passwordConfirm.toUpperCase())),t(c,a)},$$slots:{default:!0}});var T=o(ve,2);z(T,{width:U,level:3,$$events:{click:Pe},children:(c,x)=>{b();var a=L();m(()=>u(a,r.passwordReset.generate)),t(c,a)},$$slots:{default:!0}});var ne=o(T,2);z(ne,{width:U,level:2,get isLoading(){return e(N)},set isLoading(c){s(N,d(c))},$$events:{click:je},children:(c,x)=>{b();var a=L();m(()=>u(a,r.common.save)),t(c,a)},$$slots:{default:!0}});var Ce=o(ne,2);{var Re=c=>{var x=Ns(),a=C(x),h=o(a,2),q=o(h,3);R(x),m(()=>{u(a,`${r.passwordReset.success1??""}
                            ${r.passwordReset.success2??""} `),u(h,` ${r.passwordReset.success3??""} `),Fe(q,"href",e(re)||"/auth/v1/account")}),t(c,x)};$(Ce,c=>{e(g)&&c(Re)})}t(J,we)};$(M,J=>{e(ee).startsWith("password_reset")&&J(_e)},!0)}t(k,j)};$(ce,k=>{e(ee).startsWith("new_user")?k(F):k(ue,!1)})}var ye=o(ce,2);{var $e=k=>{var j=Es(),M=C(j,!0);R(j),m(()=>u(M,e(D))),t(k,j)};$(ye,k=>{e(D)&&k($e)})}R(ie),t(oe,ie)};$(I,oe=>{e(l)&&oe(V)})}t(f,E)},$$slots:{default:!0}})},$$slots:{default:!0}});var Ze=o(Ve,2);gs(Ze,{absolute:!0}),t(Xe,Oe),os()}export{Ks as component};
